<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ì˜í™” ë¦¬ë·° ìˆ˜ì •</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<div id="navbar"></div>

<main class="container">
    <div class="left">
        <div class="photo-box" id="photoBox">
            <img id="movieImg" alt="ì˜í™” í¬ìŠ¤í„°" />
            <input type="file" id="photoInput" accept="image/*" />
        </div>
        <input type="date" class="date" id="watchedDateInput" />
    </div>

    <div class="right">
        <div class="info-row">
            <input type="text" class="movie-title" id="titleInput" />
            <div id="ratingBox" class="rating"></div>
        </div>
        <textarea class="review" id="contentInput"></textarea>
        <div class="btn-group">
            <button class="btn" id="saveBtn">ìˆ˜ì •ì™„ë£Œ</button>
        </div>
    </div>
</main>

<script>


    fetch("navbar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar").innerHTML = html;

        // navbar.htmlì´ ë¡œë“œëœ ë’¤ì— ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
        document.getElementById("homeBtn").addEventListener("click", () => {
          window.location.href = "home.html";
        });
        document.getElementById("newBtn").addEventListener("click", () => {
          window.location.href = "new.html";
        });
      })
      .catch(err => console.error("ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ ì˜¤ë¥˜:", err));


        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        const movie = movieData[id];

        const movieImg = document.getElementById("movieImg");
        const titleInput = document.getElementById("titleInput");
        const watchedDateInput = document.getElementById("watchedDateInput");
        const contentInput = document.getElementById("contentInput");
        const ratingBox = document.getElementById("ratingBox");
        const photoInput = document.getElementById("photoInput");

        let selectedRating = 0;

        if(movie){
          movieImg.src = movie.posterPath;
          titleInput.value = movie.title;
          watchedDateInput.value = movie.watchedDate;
          contentInput.value = movie.content;
          selectedRating = movie.rating;
          ratingBox.textContent = "ğŸŠ".repeat(selectedRating);
        } else {
          document.querySelector("main").innerHTML = "<p>ì˜í™” ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
        }

        // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
        photoInput.addEventListener("change", e => {
          const file = e.target.files[0];
          if(file){
            const reader = new FileReader();
            reader.onload = e => { movieImg.src = e.target.result; };
            reader.readAsDataURL(file);
          }
        });

        // ë³„ì  ì„ íƒ
        ratingBox.addEventListener("click", () => {
          selectedRating = prompt("ë³„ì ì„ 1~5ë¡œ ì…ë ¥í•˜ì„¸ìš”") || selectedRating;
          selectedRating = Math.min(Math.max(Number(selectedRating),1),5);
          ratingBox.textContent = "ğŸŠ".repeat(selectedRating);
        });

     // ìˆ˜ì • ì™„ë£Œ ë²„íŠ¼: ì„œë²„ì— PUT ìš”ì²­
    document.getElementById("saveBtn").addEventListener("click", () => {
      const updatedMovie = {
        title: titleInput.value,
        watchedDate: watchedDateInput.value,
        content: contentInput.value,
        posterPath: movieImg.src,
        rating: selectedRating
      };

      fetch(`/movies/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedMovie)
      })
      .then(res => {
        if(res.ok){
          alert("ìˆ˜ì • ì™„ë£Œ! í™ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
          window.location.href = "home.html";
        } else {
          alert("ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    });
</script>
</body>
</html>
